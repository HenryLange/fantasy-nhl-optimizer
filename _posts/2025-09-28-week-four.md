---
title: "Week 4: restrictions and draft simulations"
date: 2025-09-28
---


Last week, I used the data and tables I had to make projections on both players’ and goalies’ fantasy points for the upcoming season. With that, I filtered the players and goalies so those with less than 30 games for players and 15 games for goalies, because realistically, we aren't selecting those players that aren't playing much or scoring that many fantasy points. With that set up, very basic optimization was possible by following the tables, but this week I will be using lpSolve to really get **returned optimized teams** and **experiment with teams as other players are eliminated**, similar to how drafts really work.

---


### Optimization table
For lpSolve, I needed a combined table of players and goalies to be chosen from in optimization. To do this, I combined the tables for all positions and their respective projected points. That looked something like this:
```
# putting all projected players into one table
all_players = bind_rows(top_goalies_by_proj_points,
                        centers,
                        left_wings,
                        right_wings,
                        defense,
                        wingers,
                        forwards) %>% 
  mutate(id = row_number()) %>% 
  select(id, player, position, Proj_fantasy_points)
```
I also added **"id”**, so in this new table, each player has their own number assignment. 

I added a set of binary indicator columns for each position. I added **is_C, is_LW, is_RW, etc.,** where a player gets a 1 if they play that position and 0 otherwise. The reason for this is that lpSolve needs numeric values for constraints. By turning positions into 1s and 0s, I can easily tell the optimizer how many players of each position must be included in the roster. With this, the optimizer can now enforce rules like **“at least 2 centers, 2 left wings, 4 defensemen, etc.”** using these binary columns. That step is shown below:
```
# adding binary indicator columns for each position
all_players <- all_players %>% 
  mutate(
    is_C  = if_else(position == "C", 1, 0),
    is_LW = if_else(position == "LW", 1, 0),
    is_RW = if_else(position == "RW", 1, 0),
    is_D  = if_else(position == "D", 1, 0),
    is_G  = if_else(position == "G", 1, 0),
    is_F  = if_else(position %in% c("C","LW","RW"), 1, 0), 
    is_W  = if_else(position %in% c("LW","RW"), 1, 0))
```
 
---


### restrictions
If there were no restrictions, optimization would be simple. Take the players with the highest projected points. But when it comes to fantasy, this isn't possible because hockey teams have to have a certain number of forwards, defensemen, and goalies. That's the restriction I worked on this week.

In the leagues I have played in, as well as some that I have researched, it is typical to have **2 centers, 2 right wingers, 2 left wingers, 4 defensemen, 2 goalies, and 4 more bench players of any position**. These are the restrictions on positions that I employed in my optimizer. 


---


### optimization code
The idea with the lpSolve code is to pick the combination of players that maximizes total projected points while respecting the roster rules: 2 centers, 2 left wings, 2 right wings, 4 defensemen, 2 goalies, plus 4 bench spots, for a total of **16 players**. The optimizer treats each player as either **“in” or “out”** of the team, checks that all position requirements are satisfied, and finds the selection that gives the highest possible total projected points. This way, the output is a mathematically optimized fantasy team given the projections and the players available. This is the code:
```
# Objective is to maximize projected fantasy points
objective <- all_players$Proj_fantasy_points

const.mat <- rbind(
  all_players$is_C, all_players$is_LW, all_players$is_RW, all_players$is_D, all_players$is_G)

const.dir <- c(">=", ">=", ">=", ">=", ">=", "==")

# Right-hand side: roster requirements for starters. Bench will just be filled by remaining top points
const.rhs <- c(2, 2, 2, 4, 2)

# Total number of players including bench
total_players <- 16

solution <- lp(
  direction = "max",
  objective.in = all_players$Proj_fantasy_points,
  const.mat = rbind(const.mat, rep(1, nrow(all_players))),
  const.dir = c(const.dir, "=="),
  const.rhs = c(const.rhs, total_players),
  all.bin = TRUE)

optimal_team <- all_players[solution$solution == 1, ]
```
By following some of the comments in my code, you can see the numbers and positions that are being restricted, and all of those variables in the optimizer.

---

### testing optimizer with semi-simulated draft
I wanted to test to make sure my optimizer selected players according to the restrictions and with the highest projected points. To do this, I **simulated a situation where not all players in the table were available, but the optimizer still had to return the team with the highest projected points**. The way I did this was by randomly removing 30% of the players in the table and having the optimizer work on that. This was taken care of with 2 simple lines:
```
all_players <- all_players %>% 
    slice_sample(prop = 0.7)  
```
I want to note that this isn't exactly how a draft works. This method randomly selects 30% of the players to remove, but in drafts, this is not how it works. In drafts, other very good players are likely to be taken. While I understand this, I wanted to use the process I did to ensure my optimizer worked as intended. However, **I will likely try to simulate a draft like this in week 5**.

##

I ran this simulation 5 times to get a bunch of different teams. I made a function to run draft simulations, and ran it 5 times like this:
```
# Run 5 simulations
set.seed(67)
draft_sims <- lapply(1:5, function(x) simulate_draft_simple(all_players))
```

---

### resulting teams from simulation
To show the results from my semi-draft simulation, I wanted to make some visuals to ensure the results from team to team varied and that the projected points were still high. To ensure the teams were all different, I made bar charts for teams 1, 2, and 4 from my simulation.

Team 1:
![bar_chart_proj_points_for_team1]({{ site.baseurl }}/assets/images/bar_chart_proj_points_for_team1.png)

Team 2:
![bar_chart_proj_points_for_team2]({{ site.baseurl }}/assets/images/bar_chart_proj_points_for_team2.png)

Team 4:
![bar_chart_proj_points_for_team4]({{ site.baseurl }}/assets/images/bar_chart_proj_points_for_team4.png)

As seen in all of these visuals, the projected points and specific players on each team differ. Something I thought was interesting is that Centers are usually the position picked for the bench position. The teams all need at **least 2 centers, but have between 5 and 6 centers**. This shows that centers generally have higher projected points than other positions, and with the extra picks, they are usually selected.

total projected points by team:
![compare_total_proj_points]({{ site.baseurl }}/assets/images/compare_total_proj_points.png)

This visual shows that each team varies in total projected points, but while they do vary, they are still at a very high projected point total, giving support to the idea that the optimizer is working as intended.

---

### What’s next?
I'm very satisfied with how this week went. While this week wasn't the most lines of code, it was definitely the hardest learning curve I've had to overcome, learning how to use lpSolve. Once I got a hold of it, it was awesome to see that everything I completed in weeks one through three has built up to this.

You can see my code for this week in the [code](https://henrylange.github.io/fantasy-nhl-optimizer/code/) section.

Like I mentioned before, next week I hope to run another simulation, **but have it run closer to a real draft** rather than just eliminating 30% of players from the list. Next week, I also plan on **experimenting with different scoring systems/weighting on different stats**. This is important because different leagues have different scoring systems, so it is crucial that my code can handle changes in the scoring systems to show how it changes the best optimized team.
